<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script language="javascript" type="text/javascript" src="..\dist\fhir-client.js"></script>
</head>
<body>
<h1>J FORBES APRIL 2021 - TRAINING</h1>
<p>Primarily run in MS Code against debugger</p>
<p>Sandbox Opservation - leveraging the system account</p>
<p>Specific about what it collects within the available data set</p>
<p>This is training code developed on the sandbox to learn how to handle coding in SMART on github</p>
<pre id="output">Loading...</pre>
<script>
const myLoinc = "http://loinc.org" // used to identify in the data set a specific set of data

const client  = new FHIR.client("https://r3.smarthealthit.org");
const getPath = client.getPath; //create a getPath constant against the  client package


function getcodingType(myCodings = []) {

   var myTmpVar = JSON.stringify(myCodings, null, 4)
   // testing console.log("getCodingType: " + JSON.stringify(myCodings, null, 4))
   var tVar = getPath(myCodings, "resource.code.coding")  // get the resource - RECALL this example is calling a bundle so we are starting from that level
   var coding = tVar.find(c => c.system === myLoinc);   // narrow down the data set by finding the tree level that has the  system val loinc.org
   var tVar2 = getPath(myCodings, "resource.valueQuantity")  //here getPath is enough to narrow the data set - don't need find
   // getPath looks for the entity in the second parameter from the data set in the first parameter
   // and returns an object of the entities in that path
   // for example this might be the output of the statement above and in fact was for one peice of data
   // so "resource.valueQuantity" discovers in its path the following
   // {value: 0.5,unit: "mg/dL",system: "http://unitsofmeasure.org",  code: "mg/dL",}
   // DEBUGGING - console.log("hault") // this gives me something to pasue on in debugging so i can see the contents of tVar and tVar2
                                      //  note - this will stop on every  fetched assett with debug -- unremark above and set debug
   // use try to be sure that  something is provided in case there was nothin in the getPath call
    try{
        var unitVal =  tVar2.code;
        var measureVal =  tVar2.value
    } catch{
        var unitVal =  '';
        var measureVal =  '';
    }
  var tVar3 = getPath(myCodings, "resource.referenceRange")  //here getPath is enough to narrow the data set - don't need find
  console.log("hault") // this gives me something to pasue on in debugging so i can see the contents of tVar and tVar2
                                      //  note - this will stop on every  fetched assett with debug -- unremark above and set debug
   // use try to be sure that  something is provided in case there was nothin in the getPath call
    try{ // formats high range
        var unitVal2 =  "HighRange: " + tVar3[0].high.value + " " + tVar3[0].high.unit ;
   //     var measureVal =  tVar2.value
    } catch{
        var unitVal2 =  '';
   //     var measureVal =  '';
    }
    try{ // formats high range
        var unitVal3 =  "LowRange: " + tVar3[0].low.value + " " + tVar3[0].low.unit ;
   //     var measureVal =  tVar2.value
    } catch{
        var unitVal3 =  '';
   //     var measureVal =  '';
    }

   return coding.display + "         " + measureVal + " " + unitVal + "          " + unitVal2 + " " + unitVal3|| "Unnamed Observation";
}

// fetch only the 
function myDisplay(stuff){
     const output = document.getElementById("output");
     output.innerText = stuff instanceof Error ?
        String(stuff) :
        JSON.stringify(stuff, null, 4);
     //   console.log("out: " + JSON.stringify(stuff, null, 4))
}

//var myPatient = getPatientId();
client.request('/Observation?patient=smart-1642068') // returning a bundle
 .then(data => data.entry.map(item => getcodingType( // debug on this to see breakdown at the bundle level --see everything
   // if debugging step forward one step to see breakdown in data object
   // then drop down to entry level for drill down - then into resource 
    item))) //stop on item so we can see whats inside it
 // .then(data => data.entry.map(item => getcodingType(
 //   getPath(item, "resource.code.coding")))) //stop on item so we can see whats inside it
    .then(myDisplay)
 //const MyHoo2 = "ha"
</script>
</body>
</html>
